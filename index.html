<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HIDROSANDRO | Auditoria Hídrica</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains+Mono:wght@700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #020617; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(6, 182, 212, 0.2); border-radius: 10px; }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); opacity: 0.5; }
    </style>
</head>
<body class="text-slate-100 min-h-screen overflow-x-hidden">

    <!-- Tela de Carregamento -->
    <div id="loading-screen" class="fixed inset-0 z-[100] bg-[#020617] flex flex-col items-center justify-center gap-4">
        <div class="w-12 h-12 border-4 border-cyan-500/20 border-t-cyan-500 rounded-full animate-spin"></div>
        <p class="text-cyan-500 font-mono text-xs uppercase tracking-[0.3em] animate-pulse">Sincronizando Auditoria...</p>
    </div>

    <!-- Decoração de Fundo -->
    <div class="fixed inset-0 pointer-events-none">
        <div class="absolute top-0 left-1/4 w-[500px] h-[500px] bg-cyan-600/10 blur-[120px] rounded-full"></div>
        <div class="absolute bottom-0 right-1/4 w-[500px] h-[500px] bg-purple-600/5 blur-[120px] rounded-full"></div>
    </div>

    <div class="relative max-w-7xl mx-auto p-4 md:p-8 space-y-6">
        <!-- Cabeçalho -->
        <header class="flex justify-between items-center py-4">
            <div>
                <h1 class="text-3xl font-black italic tracking-tighter uppercase">HIDRO<span class="text-cyan-500 not-italic">SANDRO</span></h1>
                <p class="text-[10px] font-bold text-slate-500 uppercase tracking-[0.2em]">Auditoria de Gestão Hídrica</p>
            </div>
            <button onclick="toggleSettings()" class="p-3 bg-white/5 hover:bg-white/10 rounded-2xl border border-white/5 transition-all text-slate-400">
                <i data-lucide="settings"></i>
            </button>
        </header>

        <!-- Cartões de Métricas -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
            <div class="bg-slate-900/60 backdrop-blur-xl p-5 rounded-3xl border border-white/5 border-b-2 border-b-slate-600 shadow-xl">
                <div class="flex justify-between items-start mb-2 text-slate-500">
                    <p class="text-[10px] font-black uppercase tracking-widest">Ref. CORSAN</p>
                    <i data-lucide="database" class="w-3 h-3"></i>
                </div>
                <div class="flex items-baseline gap-1">
                    <span id="m-ref" class="text-2xl font-mono font-black text-slate-400">---</span>
                    <span class="text-[10px] text-slate-600 italic font-bold uppercase">m³</span>
                </div>
            </div>
            <div class="bg-slate-900/60 backdrop-blur-xl p-5 rounded-3xl border border-white/5 border-b-2 border-b-cyan-500 shadow-xl">
                <div class="flex justify-between items-start mb-2 text-cyan-500">
                    <p class="text-[10px] font-black uppercase tracking-widest text-slate-500">Leitura Atual</p>
                    <i data-lucide="activity" class="w-3 h-3"></i>
                </div>
                <div class="flex items-baseline gap-1">
                    <span id="m-atual" class="text-2xl font-mono font-black text-white">---</span>
                    <span class="text-[10px] text-slate-600 italic font-bold uppercase">m³</span>
                </div>
            </div>
            <div class="bg-slate-900/60 backdrop-blur-xl p-5 rounded-3xl border border-white/5 border-b-2 border-b-blue-500 shadow-xl">
                <div class="flex justify-between items-start mb-2 text-blue-500">
                    <p class="text-[10px] font-black uppercase tracking-widest">Consumido</p>
                    <i data-lucide="droplets" class="w-3 h-3"></i>
                </div>
                <div class="flex items-baseline gap-1">
                    <span id="m-total" class="text-2xl font-mono font-black text-white">---</span>
                    <span class="text-[10px] text-slate-600 font-bold uppercase">L</span>
                </div>
            </div>
            <div class="bg-slate-900/60 backdrop-blur-xl p-5 rounded-3xl border border-white/5 border-b-2 border-b-emerald-500 shadow-xl">
                <div class="flex justify-between items-start mb-2 text-emerald-500">
                    <p class="text-[10px] font-black uppercase tracking-widest">Média Dia</p>
                    <i data-lucide="trending-up" class="w-3 h-3"></i>
                </div>
                <div class="flex items-baseline gap-1">
                    <span id="m-media" class="text-2xl font-mono font-black text-white">---</span>
                    <span class="text-[10px] text-slate-600 font-bold uppercase">L/D</span>
                </div>
            </div>
            <div class="bg-slate-900/60 backdrop-blur-xl p-5 rounded-3xl border border-white/5 border-b-2 border-b-purple-500 shadow-xl">
                <div class="flex justify-between items-start mb-2 text-purple-500">
                    <p class="text-[10px] font-black uppercase tracking-widest">Custo Est.</p>
                    <i data-lucide="dollar-sign" class="w-3 h-3"></i>
                </div>
                <div class="flex items-baseline gap-1">
                    <span class="text-[10px] text-purple-500 font-bold mr-1">R$</span>
                    <span id="m-custo" class="text-2xl font-mono font-black text-white">---</span>
                </div>
            </div>
        </div>

        <!-- Visualizador de Ciclos -->
        <div class="bg-slate-900/40 backdrop-blur-xl p-8 rounded-[2.5rem] border border-white/5 shadow-2xl">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-6 mb-8">
                <div class="flex items-center gap-4">
                    <div class="p-4 bg-cyan-500/10 rounded-2xl border border-cyan-500/20">
                        <i data-lucide="layers" class="text-cyan-500"></i>
                    </div>
                    <div>
                        <p class="text-[10px] font-black text-cyan-500 uppercase tracking-[0.3em] mb-1">Decomposição de Consumo</p>
                        <div class="flex items-baseline gap-2">
                           <span id="cycle-total-litros" class="text-3xl font-mono font-black text-white">0</span>
                           <span class="text-xs font-bold text-slate-600 uppercase">Litros Totais</span>
                        </div>
                    </div>
                </div>
                
                <div class="flex gap-4 w-full md:w-auto">
                    <div class="flex-1 md:flex-none px-6 py-4 bg-black/40 rounded-3xl border border-white/5 text-center">
                        <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-1">Ciclos (100L)</p>
                        <p id="cycle-count" class="text-3xl font-mono font-black text-white italic">0</p>
                    </div>
                    <div class="flex-1 md:flex-none px-6 py-4 bg-cyan-500/5 rounded-3xl border border-cyan-500/10 text-center text-cyan-400">
                        <p class="text-[10px] font-black uppercase tracking-widest mb-1">Resíduo</p>
                        <p class="text-3xl font-mono font-black italic"><span id="cycle-residue">0</span><span class="text-xs ml-1">L</span></p>
                    </div>
                </div>
            </div>

            <div class="h-4 w-full bg-black/40 rounded-full p-1 border border-white/5 overflow-hidden">
                <div id="cycle-progress-bar" class="h-full bg-gradient-to-r from-cyan-600 via-blue-500 to-cyan-400 rounded-full shadow-[0_0_20px_rgba(6,182,212,0.3)] transition-all duration-1000" style="width: 0%"></div>
            </div>
            
            <div class="flex justify-between mt-4 text-[10px] font-black uppercase tracking-widest">
                <span id="cycle-footer-text" class="text-slate-600">Sincronizando...</span>
                <span id="cycle-faltam" class="text-cyan-500/50">---</span>
            </div>
        </div>

        <!-- Operações -->
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
            <div class="lg:col-span-2 bg-slate-900/80 backdrop-blur-2xl p-8 rounded-[2.5rem] border border-white/10 shadow-2xl space-y-6">
                <div class="space-y-2">
                    <h3 class="text-xs font-black uppercase text-slate-400 tracking-[0.2em]">Registrar Medição</h3>
                    <p class="text-[10px] text-slate-600 font-bold uppercase italic tracking-wider">Valor atual do hidrômetro</p>
                </div>
                
                <input id="leitura-input" type="text" inputmode="decimal" placeholder="Ex: 29.097" class="w-full bg-black/60 border-2 border-white/5 rounded-3xl p-6 text-5xl font-mono font-bold text-center text-cyan-400 outline-none focus:border-cyan-500/50 transition-all">
                
                <button onclick="addLeitura()" class="w-full bg-cyan-600 hover:bg-cyan-500 text-slate-950 font-black py-6 rounded-3xl uppercase text-xs tracking-[0.3em] transition-all transform active:scale-95 flex items-center justify-center gap-3">
                    <i data-lucide="save" class="w-4 h-4"></i> Gravar na Cloud
                </button>
            </div>

            <div class="lg:col-span-3 bg-slate-900/40 backdrop-blur-xl rounded-[2.5rem] border border-white/5 overflow-hidden flex flex-col shadow-2xl">
                <div class="p-6 bg-white/5 border-b border-white/5">
                    <h3 class="text-[10px] font-black uppercase tracking-widest text-slate-500">Histórico de Auditoria</h3>
                </div>
                <div id="history-list" class="max-h-[400px] overflow-y-auto p-4 space-y-3 custom-scrollbar"></div>
            </div>
        </div>
    </div>

    <!-- Modal de Configurações -->
    <div id="settings-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/95 backdrop-blur-md hidden">
        <form onsubmit="saveSettings(event)" class="bg-slate-900 border border-white/10 rounded-[2.5rem] w-full max-w-md p-8 shadow-2xl space-y-6">
            <h2 class="text-xl font-black uppercase text-cyan-500 tracking-widest italic">Configurações Base</h2>
            <div class="space-y-4">
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-500 uppercase ml-2">Leitura Inicial CORSAN (m³)</label>
                    <input id="conf-leitura" type="number" step="0.001" class="w-full bg-black/40 border border-white/5 rounded-2xl p-4 font-mono text-white outline-none focus:border-cyan-500">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase ml-2">Taxa Fixa (R$)</label>
                        <input id="conf-taxa" type="number" step="0.01" class="w-full bg-black/40 border border-white/5 rounded-2xl p-4 font-mono text-white outline-none focus:border-cyan-500">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase ml-2">Preço m³ (R$)</label>
                        <input id="conf-preco" type="number" step="0.01" class="w-full bg-black/40 border border-white/5 rounded-2xl p-4 font-mono text-white outline-none focus:border-cyan-500">
                    </div>
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-500 uppercase ml-2">Data Inicial da Auditoria</label>
                    <input id="conf-data" type="date" class="w-full bg-black/40 border border-white/5 rounded-2xl p-4 font-mono text-white outline-none focus:border-cyan-500">
                </div>
            </div>
            <div class="flex gap-3">
                <button type="button" onclick="toggleSettings()" class="flex-1 py-4 text-[10px] font-black uppercase text-slate-500">Cancelar</button>
                <button type="submit" class="flex-1 py-4 text-[10px] font-black uppercase bg-cyan-600 text-slate-950 rounded-2xl">Atualizar Tudo</button>
            </div>
        </form>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'hidrosandro-v2';
        const initialToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let historico = [];
        // Configuração padrão baseada no seu input
        let config = {
            leituraInicial: 28.282,
            taxaFixa: 39.32,
            precoM3: 8.80,
            dataInicio: '2026-02-05'
        };

        const $ = (id) => document.getElementById(id);

        async function init() {
            try {
                if (initialToken) await signInWithCustomToken(auth, initialToken);
                else await signInAnonymously(auth);
            } catch (err) { console.error("Erro Auth", err); }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'consumo');
                    onSnapshot(docRef, (snap) => {
                        if (snap.exists()) {
                            const data = snap.data();
                            historico = data.leituras || [];
                            if (data.config) {
                                config = {
                                    leituraInicial: parseFloat(data.config.leituraInicial) || 28.282,
                                    taxaFixa: parseFloat(data.config.taxaFixa) || 39.32,
                                    precoM3: parseFloat(data.config.precoM3) || 8.80,
                                    dataInicio: data.config.dataInicio || '2026-02-05'
                                };
                            }
                        } else {
                            // Se for a primeira vez, já cria um registro com a leitura atual que você informou
                            historico = [{ id: Date.now(), valor: 29.097, timestamp: Date.now() }];
                            save();
                        }
                        render();
                        $('loading-screen').classList.add('hidden');
                    }, (err) => {
                        console.error("Erro Firestore", err);
                        $('loading-screen').classList.add('hidden');
                    });
                }
            });
        }

        window.addLeitura = async () => {
            const input = $('leitura-input');
            const val = parseFloat(input.value.replace(',', '.'));
            if (!isNaN(val)) {
                historico.unshift({ id: Date.now(), valor: val, timestamp: Date.now() });
                await save();
                input.value = '';
            }
        };

        window.deleteItem = async (id) => {
            historico = historico.filter(i => i.id !== id);
            await save();
        };

        window.toggleSettings = () => {
            $('settings-modal').classList.toggle('hidden');
            if (!$('settings-modal').classList.contains('hidden')) {
                $('conf-leitura').value = config.leituraInicial;
                $('conf-taxa').value = config.taxaFixa;
                $('conf-preco').value = config.precoM3;
                $('conf-data').value = config.dataInicio;
            }
        };

        window.saveSettings = async (e) => {
            e.preventDefault();
            config = {
                leituraInicial: parseFloat($('conf-leitura').value),
                taxaFixa: parseFloat($('conf-taxa').value),
                precoM3: parseFloat($('conf-preco').value),
                dataInicio: $('conf-data').value
            };
            await save();
            toggleSettings();
        };

        async function save() {
            if (!currentUser) return;
            const docRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'settings', 'consumo');
            await setDoc(docRef, { leituras: historico, config: config });
        }

        function render() {
            const sorted = [...historico].sort((a, b) => b.timestamp - a.timestamp);
            const leituraAtual = sorted.length > 0 ? sorted[0].valor : config.leituraInicial;
            
            // Cálculo do Consumo em m³ e Litros
            // Se a leitura atual for muito maior que a inicial (ex: erro de digitação), limitamos para não quebrar a UI
            const diffM3 = Math.max(0, leituraAtual - config.leituraInicial);
            const totalLitros = Math.round(diffM3 * 1000);
            
            // Ciclos de 100 Litros
            const numCiclos = Math.floor(totalLitros / 100);
            const litrosRestantes = totalLitros % 100;
            
            // Tempo Decorrido
            const dataInicioObj = new Date(config.dataInicio + 'T00:00:00');
            const diasDecorridos = Math.max(1, (Date.now() - dataInicioObj.getTime()) / (1000 * 60 * 60 * 24));
            
            // Médias e Projeções
            const mediaL = totalLitros / diasDecorridos;
            const proj30d = (mediaL * 30) / 1000;
            const custoEst = config.taxaFixa + (proj30d * config.precoM3);

            // Atualização dos Cards de Topo
            $('m-ref').innerText = config.leituraInicial.toFixed(3).replace('.', ',');
            $('m-atual').innerText = leituraAtual.toFixed(3).replace('.', ',');
            $('m-total').innerText = totalLitros.toLocaleString('pt-BR');
            $('m-media').innerText = Math.round(mediaL).toLocaleString('pt-BR');
            $('m-custo').innerText = custoEst.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});

            // Atualização do Visualizador de Ciclos
            $('cycle-total-litros').innerText = totalLitros.toLocaleString('pt-BR');
            $('cycle-count').innerText = numCiclos.toLocaleString('pt-BR');
            $('cycle-residue').innerText = Math.round(litrosRestantes);
            
            // Barra de progresso (0 a 100%)
            $('cycle-progress-bar').style.width = `${litrosRestantes}%`;
            $('cycle-footer-text').innerText = `Ciclo #${(numCiclos + 1).toLocaleString('pt-BR')} em andamento`;
            $('cycle-faltam').innerText = `Faltam ${Math.round(100 - litrosRestantes)}L para o ciclo #${numCiclos + 2}`;

            // Histórico
            $('history-list').innerHTML = sorted.map((item, idx) => `
                <div class="flex justify-between items-center p-4 bg-white/5 rounded-2xl border border-white/5 group hover:bg-white/10 transition-all">
                    <div class="flex gap-4 items-center">
                        <div class="w-10 h-10 flex items-center justify-center bg-black/40 text-cyan-500 text-[10px] font-bold rounded-2xl">
                            #${sorted.length - idx}
                        </div>
                        <div>
                            <p class="text-xs font-black text-slate-300">${new Date(item.timestamp).toLocaleDateString('pt-BR')}</p>
                            <p class="text-[10px] text-slate-500 font-mono">${new Date(item.timestamp).toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'})}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-6">
                        <p class="font-mono font-black text-xl text-white tracking-tighter">${item.valor.toFixed(3).replace('.', ',')}</p>
                        <button onclick="deleteItem(${item.id})" class="text-slate-700 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            
            lucide.createIcons();
        }

        window.onload = init;
    </script>
</body>
</html>
